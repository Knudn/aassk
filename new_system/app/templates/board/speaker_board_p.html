<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Race Commentary Information</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">    


<script src="{{url_for('static', filename='js/jquery-3.6.0.min.js')}}"></script>
<script src="{{url_for('static', filename='js/bootstrap.bundle.min.js')}}"></script>
<script src="{{url_for('static', filename='js/socket.io.js')}}"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">


<link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">


  <style>
.retry-indicator-container {
    position: relative;
}

.retry-indicator {
    position: absolute;
    top: -20px; /* Adjust this value to position the indicator vertically */
    right: 0;
    padding: 5px 10px;
    background-color: #dc3545;
    color: #fff;
    font-weight: bold;
    border-radius: 4px;
}

.custom-btn {
    padding: 10px 15px;
    font-size: 12px;

}

.custom-icon {
    font-size: 1.5em; /* Adjust based on the button's font size */
}
body, html {
  overflow-x: hidden; /* Prevent horizontal scrolling */
  max-width: 100vw; /* Prevent width changes */
  font-size: 14px; /* Adjust base font size to make text smaller */
}
.accordion-header, .accordion-button {
    padding: 0.5rem 0.8rem; /* Adjust padding as needed */
}


.accordion-button {
    display: flex;
    justify-content: center;
    align-items: center;
}

.accordion-title {
    margin: 0; /* Remove default margin */
    flex-grow: 1; /* Allows the title to take up available space */
    text-align: center; /* Center the title text */
    font-size: 18px;
    font-family: Tahoma, sans-serif;
}

.accordion-item {
    margin-bottom: 0.5rem; /* Less space between items */
    border: 1px solid #e7e7e7; /* Lighter border */
}

.accordion-body {
    padding: 0.5rem 1rem; /* Slimmer padding */
}


    .modal-dialog top_race {
    width: auto;
    max-width: 100%; 
    }

    .table-responsive {
    overflow-x: auto;
    }


    #driver_status {
        width: 98%;
        
    }
    .driver-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .table-responsive {
    overflow-x: auto;
}
    .driver {
      width: 48%;
      border-top: 1px solid black;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      flex-grow: 0;

      
    }
    .driver-info {
      text-align: center;
      margin-bottom: 20px;
    }
    .driver-details {
      margin-top: 10px;
      font-size: 0.9em;
      text-align: center;
    }
    .drivername {
        font-size: x-large;
    }
    .race-entry {
    margin-bottom: 10px;
    padding: 10px;
}

.date-title-group {
    width: 100%;
    margin-bottom: 15px;
}

.date-group {
    width: 100%;
    margin-bottom: 15px;
    font-size: 1.2em;
}

.race-entry {
    
    padding: 0px;
}

.date-title {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
}

.table {
    text-align: center;
}

.driver-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.driver-left, .driver-right {
    width: 45%;
    padding: 5px;
    text-align: center;
}

.driver-separator {
    width: 10%;
    font-weight: bold;
}

.winner {
    background-color: rgba(37, 255, 37, 0.658);
    color: rgb(0, 0, 0);
}

.loser {
    background-color: rgba(255, 48, 48, 0.623);
    color: rgb(0, 0, 0);
}

.top-driver-match {
    background-color: aqua;
}


.driver-container {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.middle-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    max-width: 10px;
}

.arrow-buttons {
    margin-top: 5px;
    padding-left: 50%;
    padding-right: 50%;
}


#arrow-right {
    margin-top: 5px;
}

#settingbutton {
    margin-top: 5px;
}

.header_title {
    text-align: center;
}

.strikethrough {
    text-decoration: line-through;
}

/* Custom CSS to make tabs take full width */
.nav-tabs .nav-item {
    width: 50%; /* Adjust this value based on the number of tabs */
    text-align: center;
}

.nav-tabs .nav-link {
    border-radius: 0;
}


#top_driver_bar {
    display: flex;

    justify-content: space-between; /* Distribute content evenly */
}

#top_driver_bar span {
    display: inline-block;
    vertical-align: middle;
    padding-left: 2%;
    padding-right: 2%;
}



  </style>
</head>
<body>
    
    <div class="alert alert-info" role="alert" style="margin-bottom: 0px; padding:10px;">
        <h2 class="header_title"></h2>
      </div>
      
    <div class="alert alert-warning" role="alert" style="padding:5px; font-size: 15px;" id="top_driver_bar">
        <span id="currentHeat"></span>
        <span id="eventTitle"></span>
        <span id="dayTitle"></span>
    </div>
    
      </div>
      <div id="alert_msg">

        </div>

    <div class="driver-container">
        <div id="left-driver" class="driver">
            <!-- Left Driver Content -->
        
        </div>
    
        <div class="middle-container">
            <div>
                <h1 class="heat_num" style="font-size: 30px">1/1</h1>
                </div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" id="settingbutton">
                <span id="boot-icon" class="bi bi-gear" style="font-size: 28px; opacity: 1; -webkit-text-stroke-width: 0px;"></span>
            </button>
            <br>
            <button type="button" class="btn btn-primary" id="loadDataButton" data-bs-toggle="modal" data-bs-target="#eventsModal">

                <span id="boot-icon" class="bi bi-list-check" style="font-size: 28px; opacity: 1; -webkit-text-stroke-width: 0px;"></span>

            </button>
            <br>
            <button type="button" class="btn btn-primary" id="top_driver_button" data-bs-toggle="modal" data-bs-target="#top_driver_button_model" style="margin-bottom: 15px;">

                <span id="boot-icon" class="bi bi-stopwatch" style="font-size: 28px; opacity: 1; -webkit-text-stroke-width: 0px;"></span>

            </button>
            

            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#mockDataModal">
                <span id="boot-icon" class="bi bi-arrow-clockwise" style="font-size: 28px; opacity: 1; -webkit-text-stroke-width: 0px;"></span>
            </button>
        
            <div class="arrow-buttons" style="padding-top: 20px;">
                <button id="arrow-left" class="btn btn-secondary custom-btn">
                    <i class="bi bi-arrow-left custom-icon"></i>
                </button>
                <button id="arrow-right" class="btn btn-secondary custom-btn">
                    <i class="bi bi-arrow-right custom-icon"></i>
                </button>
            </div>

            
        </div>
    
        <div id="right-driver" class="driver">
            <!-- Right Driver Content -->
        </div>
    </div>


<!-- Mock Data Modal -->
<div class="modal fade" id="mockDataModal" tabindex="-1" role="dialog" aria-labelledby="mockDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mockDataModalLabel">Kjør på nytt tabell</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Driver Name</th>
                            <th>Title</th>
                            <th>CID</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>    
<!-- EVENT ORDER MODEL -->
<div class="modal fade" id="eventsModal" tabindex="-1" role="dialog" aria-labelledby="eventsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document"> <!-- Use modal-lg for larger modal -->
      <div class="modal-content">
        <div class="modal-header" style="text-align: center;">
          <h5 class="modal-title" id="eventsModalLabel" >Event Rekkefølge</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col">Order</th>
                <th scope="col">Event</th>
                <th scope="col">Heat</th>
                
              </tr>
            </thead>
            <tbody id="eventTableBody">
              <!-- Event data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<!-- TOP DRIVERS -->
<div class="modal fade" id="top_driver_button_model" tabindex="-1" role="dialog" aria-labelledby="eventsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document"> <!-- Use modal-lg for larger modal -->
      <div class="modal-content" style="align-items: center;">
        <div class="modal-header" style="text-align: center;">
          <h5 class="modal-title" id="eventsModalLabel" >Bestetid - top 10</h5>
        </div>
    <!-- Centered Tabs -->
    <div class="container">
        <ul class="nav nav-tabs row">
            <li class="nav-item col">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab1">TITLE_1_TITLE_2_HEAT</a>
            </li>
            <li class="nav-item col">
                <a class="nav-link" data-bs-toggle="tab" href="#tab2">TITLE_1_TITLE_2</a>
            </li>
            <li class="nav-item col">
                <a class="nav-link" data-bs-toggle="tab" href="#tab3">TITLE_1</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab1">
                <!-- Table for Tab 1 -->
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Snowmobile</th>
                            <th scope="col">Time</th>
                        </tr>
                    </thead>
                    <tbody>

                        <!-- More rows as needed -->
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="tab2">
                <!-- Table for Tab 2 -->
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Heat</th>
                            <th scope="col">Name</th>
                            <th scope="col">Snowmobile</th>
                            <th scope="col">Time</th>
                        </tr>
                    </thead>
                    <tbody>

                        <!-- More rows as needed -->
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="tab3">
                <!-- Table for Tab 1 -->
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Event</th>
                            <th scope="col">Heat</th>
                            <th scope="col">Name</th>
                            <th scope="col">Snowmobile</th>
                            <th scope="col">Time</th>
                        </tr>
                    </thead>
                    <tbody>

                        <!-- More rows as needed -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

      </div>
    </div>
  </div>
    
<!--SETTINGS MODEL -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Speaker page settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </button>
                
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <div class="input-group-prepend">
                        <span class="input-group-text" id="">Archive endpoint:</span>
                        </div>
                        <input type="text" class="form-control" value="{{ SpeakerPageConfig_json.h_server_url }}" id="h_server_url">
                    </div>
                    <br>
                    <div class="form-check">
                        {% if SpeakerPageConfig_json.matching_parallel == False %}
                        <input class="form-check-input" type="checkbox" value="True" id="matching_parallel">
                        {% else %}
                        <input class="form-check-input" type="checkbox" value="True" id="matching_parallel" checked>
                        {% endif %}
                        
                        <label class="form-check-label" for="matching_parallel">
                            Only display matching parallel races
                        </label>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" aria-label="Close">Close</button>
                    <button type="button" class="btn btn-primary" id="saveChanges">Save Changes</button>
                </div>
            </div>
            </div>
        </div>
        </div>
      </div>
    </div>
  </div>

<script>
    h_server_url = "{{ SpeakerPageConfig_json.h_server_url }}"
    
</script>
  <script>
function add_websocket_live_timer() {
    const ws = new WebSocket("ws://192.168.1.50:4444/");
    var x;
    var arr = [];

    function update_live_data(newData) {
        document.getElementsByClassName("T1")[0].innerHTML = newData.Driver1.time;
        document.getElementsByClassName("T2")[0].innerHTML = newData.Driver2.time;
    }
    
    ws.onmessage = function(event){
        var arr = JSON.parse(event.data);
        setTimeout(() => {
            update_live_data(arr);
        }, 1);
    };
}
document.getElementById('loadDataButton').addEventListener('click', function() {
    fetch('/api/get_event_order')
        .then(response => response.json())
        .then(data => {
            const eventTableBody = document.getElementById('eventTableBody');
            eventTableBody.innerHTML = ''; // Clear previous content
            data.forEach(event => {
                const tableRow = document.createElement('tr');

                // Add class to grey out if disabled
                if(event.Enabled === 0) {
                    tableRow.classList.add('table-secondary', 'strikethrough');
                }

                // Set background color if active
                if (event.Active) {
                    active = "style=background:aquamarine"
                } else {
                    active = ""
                }

                // Create table data with potential strikethrough
                const orderTd = `<td class="${event.Enabled === 0 ? 'strikethrough' : ''}" ${active}>${event.Order}</td>`;
                const eventTd = `<td class="${event.Enabled === 0 ? 'strikethrough' : ''}" ${active}>${event.Event}</td>`;
                const heatTd = `<td class="${event.Enabled === 0 ? 'strikethrough' : ''} " ${active}>${event.Heat}</td>`;
                
                // Set innerHTML of the table row
                tableRow.innerHTML = orderTd + eventTd + heatTd;

                eventTableBody.appendChild(tableRow);
            });
        })
        .catch(error => console.error('Error:', error));
});

table_entry_count = 0
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('top_driver_button').addEventListener('click', function() {
        console.log(title_name[0],title_name[1],title_name[2])
        fetch(`/api/get_timedata/?title_1=${title_name[0]}&title_2=${title_name[1]}&heat=${title_name[2]}&single_all=true&entries_per_filter=10&unique_names=true`)

        .then(response => response.json())
        .then(data => {

            
            // Clear existing data in tables and reset tab titles
            document.querySelectorAll('.tab-pane').forEach((tabPane, index) => {
                tabPane.querySelector('table tbody').innerHTML = '';
                const tabLink = document.querySelector(`.nav-tabs .nav-item:nth-child(${index + 1}) a`);
                if (tabLink) {
                    tabLink.textContent = 'Loading...'; // Temporary title
                }
            });
            const recordCount = {
                tab1: 0,
                tab2: 0,
                tab3: 0
            };
            // Process each record and append it to the right table
            Object.keys(data).forEach(key => {

                const event = data[key];
                let tableBody, tabTitle;
                

                if (key.includes('title_1+title_2+heat_') && recordCount.tab1 < 10) {
                    tableBody = document.querySelector('#tab1 table tbody') ;
                    tabTitle = "Heat " + event.heat;
                    tab = 1
                    recordCount.tab1++;
                } else if (key.includes('title_1+title_2_')&& recordCount.tab2 < 10 ) {
                    tableBody = document.querySelector('#tab2 table tbody');
                    tabTitle = event.title_2;
                    tab = 2
                    recordCount.tab2++;
                } else if (key.includes('title_1_')&& recordCount.tab3 < 10 ) {
                    tableBody = document.querySelector('#tab3 table tbody');
                    tabTitle = event.title_1;
                    tab = 3
                    recordCount.tab3++;
                } else {
                    return
                }
                // Update tab title
                const tabLink = document.querySelector(`.nav-tabs .nav-item:nth-child(${key.includes('title_1+title_2+heat_') ? 1 : key.includes('title_1+title_2_') ? 2 : 3}) a`);
                if (tabLink) {
                    tabLink.textContent = tabTitle;
                }
                let time_data = (event.finishtime / 1000).toFixed(3) + " sec";
                table_entry_count += 1
                // Create a row for the event
                const row = document.createElement('tr');
                if (tab == 1) {
                    row.innerHTML = `
                        <td>${event.first_name + " " + event.last_name}</td>
                        <td>${event.snowmobile}</td>
                        <td>${time_data}</td>
                    `;
                } else if (tab == 2) {
                    row.innerHTML = `
                        <td>${event.heat}</td>
                        <td>${event.first_name + " " + event.last_name}</td>
                        <td>${event.snowmobile}</td>
                        <td>${time_data}</td>
                    `;
                } else if (tab == 3) {
                    row.innerHTML = `
                        <td>${event.title_2}</td>
                        <td>${event.heat}</td>
                        <td>${event.first_name + " " + event.last_name}</td>
                        <td>${event.snowmobile}</td>
                        <td>${time_data}</td>
                    `;
                }

                // Append the row to the table body
                if (tableBody) {
                    tableBody.appendChild(row);
                } else {
                    console.error('Table body not found for selector:', key);
                }
            });
        })
        .catch(error => console.error('Error:', error));
    });


});




  </script>
  
  <script>

    var x;
    var arr = [];

    function updateContent(newData) {
        document.getElementsByClassName("T1")[0].innerHTML = newData.Driver1.time;
        document.getElementsByClassName("T2")[0].innerHTML = newData.Driver2.time;
        var D1_name = newData.Driver1.name
        var D2_name = newData.Driver2.name
    }
    


  </script>

  <script>
    //Save changes inserted to model
    $(document).ready(function() {
        $('#saveChanges').click(function() {
            // Collect the new settings data
            var isCheckboxChecked = $('#matching_parallel').prop('checked');
            var h_server_url = $('#h_server_url')[0].value
            var settingsData = {
                matchingParallel: isCheckboxChecked,
                h_server_url:h_server_url
            };
    
            // Send the data to the server
            $.ajax({
                url: '/board/speaker',  // Replace with your API endpoint
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(settingsData),
                success: function(response) {
                    // Handle success response
                    console.log('Settings updated:', response);
                    // Reload the page
                    location.reload();
                },
                error: function(xhr, status, error) {
                    // Handle error response
                    console.error('Update failed:', status, error);
                }
            });
        });
    });



    </script>
    


    <script>
        {% if SpeakerPageConfig_json.matching_parallel == True %}
            let parallel_only = true;
        {% else %}
            let parallel_only = false;
        {% endif %}
    </script>


  <script>

    function validate_mode(data) {

        current_mode = data[0]["race_config"]["MODE"]
        console.log(current_mode)

        if (current_mode != old_mode) {
            location.reload()
        } 

        old_mode = data[0]["race_config"]["MODE"]

        
    }

    var MD5 = function(d){var r = M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}

    let driverPairs = [];
    let currentPairIndex = 0;

    let array_checksum = ""
    var old_results = ""
    let title_name = []


    $(document).ready(function() {
        // API call to fetch initial data
        $.ajax({
            url: '/api/get_current_startlist_w_data', // API URL
            type: 'GET',
            success: function(data) {
                
                old_mode = data[0]["race_config"]["MODE"]
                validate_mode(data)
                displayActiveDrivers(data);
                document.getElementsByClassName("header_title")[0].innerHTML = data[0]["race_config"]["TITLE_1"] + "-" + data[0]["race_config"]["TITLE_2"] + " (" + data[0]["race_config"]["HEAT"] + "/" + data[0]["race_config"]["HEATS"]+")";
                title_name = [data[0]["race_config"]["TITLE_1"], data[0]["race_config"]["TITLE_2"], data[0]["race_config"]["HEAT"]]
                console.log(data)
                if (data[1] == undefined) {
                    console.log("asdasd")
                    insert_alert("NO DRIVERS! (JOSTEIN STRESSER SANNSYNELIGVIS MED Å SETTE OPP STARTLISTENE)")
                } else {
                    insert_alert("clean")
                }
                
                old_results = MD5(JSON.stringify(data));
            },
            error: function() {
                console.log('Error fetching data from API');
            }
        });

        const socket = io.connect('http://' + document.domain + ':' + location.port);
        console.log(location.port)

        socket.on('connect', function() {
            console.log('Connected to the server');
            

            socket.emit('join', { username: 'John', room: 'room1' });
        });
        add_websocket_live_timer()

        socket.on('response', function(dataString) {
            
            const data = JSON.parse(dataString);
            new_title = data[0]["race_config"]["TITLE_1"] + "-" + data[0]["race_config"]["TITLE_2"] + " (" + data[0]["race_config"]["HEAT"] + "/" + data[0]["race_config"]["HEATS"]+")";
            
            if (!data[0]["drivers"]) {
                location.reload()
            }
            var new_result = MD5(JSON.stringify(dataString)); 

            if (!(new_result == old_results)) {
                displayActiveDrivers(data);
                validate_mode(data)
                title_name = [data[0]["race_config"]["TITLE_1"], data[0]["race_config"]["TITLE_2"], data[0]["race_config"]["HEAT"]]
                document.getElementsByClassName("header_title")[0].innerHTML = new_title;
                old_results = new_result
            } else {
                console.log("Nope dude")
            }
            

            //renderData(data);
            
        });

        const socket_retry = io.connect('http://' + document.domain + ':' + location.port);

        socket_retry.on('connect', function() {
            console.log('Connected to the server');
            socket_retry.emit('join', { username: 'socket_retry', room: 'socket_retry' });
        });
        
        socket_retry.on('response', function(dataString) {
            console.log(dataString);
            const data = JSON.parse(dataString);
            display_retry_entries(data);
        });
        // Function to display active drivers
        let driverPairs = [];

let currentPairIndex = 0;

async function displayActiveDrivers(data) {
    // Store all driver pairs
    driverPairs = data.filter(item => item.drivers);

    // Find the index of the first pair with an active driver
    currentPairIndex = driverPairs.findIndex(pair => pair.drivers.some(driver => driver.active));

    if (currentPairIndex === -1) {
        // If no active drivers are found, default to the first pair
        currentPairIndex = 0;
    }

    // Call to update the display with the current pair
    await updateDriverDisplay();
}

document.getElementById('arrow-left').addEventListener('click', function() {
    if (currentPairIndex > 0) {
        currentPairIndex--;
        updateDriverDisplay();
    }
});

document.getElementById('arrow-right').addEventListener('click', function() {
    if (currentPairIndex < driverPairs.length - 1) {
        currentPairIndex++;
        updateDriverDisplay();
    }
});

let driver_names = []

async function updateDriverDisplay() {
    
    if (driverPairs[currentPairIndex] && driverPairs[currentPairIndex].drivers) {
        const drivers = driverPairs[currentPairIndex].drivers;
        document.getElementsByClassName("heat_num")[0].innerHTML = (currentPairIndex + 1)+"/"+driverPairs.length;
        active_session = (driverPairs.findIndex(pair => pair.drivers.some(driver => driver.active)) + 1)
        if (active_session == (currentPairIndex + 1)) {
            // Change the text color
            document.getElementsByClassName("heat_num")[0].style.color = "red"; // Change 'red' to your desired color
        } else {
            // Optional: set a default color if the condition is not met
            document.getElementsByClassName("heat_num")[0].style.color = "black"; // Change 'black' to your desired default color
        }
        const leftDriver = drivers[0] || {};
        const rightDriver = drivers[1] || {};

        const left_driver_name = (leftDriver.first_name + " " + leftDriver.last_name) || '';
        const right_driver_name = (rightDriver.first_name + " " + rightDriver.last_name) || '';

        if (driver_names.length = 2) {
            driver_names = []
        }
        driver_names.push(left_driver_name)
        driver_names.push(right_driver_name)



        // Update the HTML content of the driver divs
        $('#left-driver').html(websocket_driver_data(leftDriver, 1));
        $('#right-driver').html(websocket_driver_data(rightDriver, 2));
        try {
            
            // Load and append snowmobile models
            $('#left-driver').append(get_overal_table(1));
            $('#right-driver').append(get_overal_table(2));

            //WINS - LADDER
            const leftSnomobileModels = await get_snomobile_models(left_driver_name);
            $('#left-driver').append(display_snowmobile_models(leftSnomobileModels, 1));
            const rightSnomobileModels = await get_snomobile_models(right_driver_name);            
            $('#right-driver').append(display_snowmobile_models(rightSnomobileModels, 2));

            //WINS -SINGLE
            const leftsingle_result = await get_single_results(left_driver_name);
            $('#left-driver').append(display_single_position(leftsingle_result, 1));
            const rightsingle_result = await get_single_results(right_driver_name);            
            $('#right-driver').append(display_single_position(rightsingle_result, 2));

            try {
            //TOP TIME
            const top_speed_data = await get_top_driver_header(title_name);
            display_get_top_driver_header(top_speed_data)
            } catch (error) {
                console.log('Error getting top speeds for current:', error)
            }
            // Load and append ladder data
            const leftLadderData = await get_ladder_data(left_driver_name);
            $('#left-driver').append(display_parallel_history(leftLadderData, left_driver_name, right_driver_name, 1));

            const rightLadderData = await get_ladder_data(right_driver_name);
            $('#right-driver').append(display_parallel_history(rightLadderData, left_driver_name, right_driver_name, 2));

            //Retry entries
            const retry_entries = await get_retry_entries("retry");
            $('#left-driver').append(display_retry_entries(retry_entries));

        } catch (error) {
            console.error('Error updating driver display:', error);
        }
    }
}

function get_top_driver_header(title_name) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `/api/get_timedata/?title_1=${title_name[0]}&title_2=${title_name[1]}&heat=${title_name[2]}&single_all=true&entries_per_filter=1&unique_names=true`,
            type: 'GET',
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject('Error fetching snowmobile models');
            }
        });
    });
}

function get_retry_entries(title_name) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `/api/retry_entries`,
            type: 'GET',
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject('Error fetching snowmobile models');
            }
        });
    });
}

function milliseconds_to_sec(ms) {
    return (ms / 1000).toFixed(3)
}

function insert_alert(msg) {
    if (msg == "clean") {
        var alert_div = document.getElementById('alert_msg');
        alert_div.innerHTML = "";
    } else {
        alert_msg = `
        <div style="text-align: center;" class="alert alert-danger" role="alert">
            ${msg}
        </div>
            `
        var alert_div = document.getElementById('alert_msg');
        alert_div.innerHTML = alert_msg;
    }


}

function display_get_top_driver_header(data) {
    let heat = data["title_1+title_2+heat_0"]
    let event = data["title_1+title_2_0"]
    let day = data["title_1_0"]
    
    if (heat != undefined) {
        document.getElementById('currentHeat').innerHTML = `<strong>Current Heat:</strong> ${heat.first_name} ${heat.last_name} - ${milliseconds_to_sec(heat.finishtime)}`;
    } else {
        document.getElementById('currentHeat').innerHTML = `<strong>Heat:</strong> Not started`;
    }
    if (event != undefined) {
        document.getElementById('eventTitle').innerHTML = `<strong>${event.title_2}:</strong> ${event.first_name} ${event.last_name} - ${milliseconds_to_sec(event.finishtime)}`;
    } else {
        document.getElementById('eventTitle').innerHTML = `<strong>EVENT:</strong> Not started`
    }

    if (day != undefined) {
        document.getElementById('dayTitle').innerHTML = `<strong>${day.title_1}:</strong> ${day.first_name} ${day.last_name} - ${milliseconds_to_sec(day.finishtime)}`;
    } else {
        document.getElementById('dayTitle').innerHTML = `<strong>DAY:</strong> Not started`;
    }
}

    function get_overal_table(num) {
        table_base = `
        <table id="overal_driver_table${num}" class="table">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Year</th>
                    <th scope="col">Wins</th>
                    <th scope="col">loses</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        `
        return(table_base)
    }

    // Function to format driver information
    function websocket_driver_data(driver,num) {
        if (!driver.first_name) {
            return '<p>No active driver</p>';
        }
        var finishTime = (driver.time_info && driver.time_info.FINISHTIME > 0) 
                            ? (driver.time_info.FINISHTIME / 1000).toFixed(2) + ' seconds' 
                            : 'N/A';

        let finish_time_sec= (driver.time_info.FINISHTIME / 1000).toFixed(3) + " Sec";
        var table_color = "" 
        if (driver.status == "0") {
            var status = "Ikke Fullført" 
            table_color = "bg-info p-2 text-dark bg-opacity-25"

        } else if (driver.status == "1") {
            var status = "Vinner"
            table_color = "bg-success p-2 text-dark bg-opacity-25"
        }
        else if (driver.status == "2") {
            var status = "Taper"
            table_color = "bg-danger p-2 text-dark bg-opacity-25"
        }
        if (driver.time_info.PENELTY == "0") {
            var penelty = "" 
        } else if (driver.time_info.PENELTY == "2") {
            var penelty = "DNF" 
            table_color = table_color + " border-warning "
        } else if (driver.time_info.PENELTY == "1") {
            var penelty = "DNS" 
            table_color = table_color + " border-primary "
        } else if (driver.time_info.PENELTY == "3") {
                var penelty = "DSQ" 
                table_color = table_color + " border-secondary "
        }
        


        return `<div class="driver-info">
                    <div id=drivername>
                    <h3 class=active_drivers>${driver.first_name} ${driver.last_name}</h3>
                    <h4 class="T${num}">0</h4>
                    </div>
                    <div class="driver-details">
                    </div>
                </div>
                <div id="driver_status" class="border border-5 ${table_color} rounded">
                    <div style="text-align: center;">
                        <h3>${penelty}</h3>
                    </div>
                    <table class="table">
                        <tbody>
                            <tr>
                                <td colspan="2">${driver.club}</td>
                                <td>${driver.vehicle}</td>
                                <td>${finish_time_sec}</td>
                                <td>${status}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <hr width="80%" color="green" />`; 
    }
    
});
    function get_ladder_data(driver_name) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${h_server_url}/get_parallel_results/${driver_name}`,
            type: 'GET',
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject('Error fetching ladder data');
            }
        });
    });
}



function get_snomobile_models(driver_name) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${h_server_url}/get_ladder_placement_sql/${driver_name}`,
            type: 'GET',
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject('Error fetching snowmobile models');
            }
        });
    });
}

function get_single_results(driver_name) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: `${h_server_url}/get_single_placement_sql/${driver_name}`,
            type: 'GET',
            success: function(data) {
                resolve(data);
            },
            error: function() {
                reject('Error fetching snowmobile models');
            }
        });
    });
}




function display_parallel_history(data, topDriver1, topDriver2, driver_int) {
    // Group data by date and title_day
    if (data[0]["None"]) {
        return
    }
    var groupedByDateAndTitle = data.reduce(function (acc, item) {
        var groupKey = item.date + ' - ' + item.title_day + ' ' + item.title;
        acc[groupKey] = acc[groupKey] || [];
        acc[groupKey].push(item);
        return acc;
    }, {});

    // Sort keys in descending order of date
    var sortedKeys = Object.keys(groupedByDateAndTitle).sort(function(a, b) {
        return new Date(b.split(' - ')[0]) - new Date(a.split(' - ')[0]);
    });

    var displayHTML = "";    
    driver_status = {d1:{win:0, lose:0}, d2:{win:0, lose:0}}
    driver_status_year = {"Totale":{d1:{win:0, lose:0}, d2:{win:0, lose:0}}}

    // Iterate over each group and create HTML
    sortedKeys.forEach(function(key) {
        let count = 0;
        groupedByDateAndTitle[key].forEach(function(item) {
            var isTopDriverMatch = (item.d1_name === topDriver1 && item.d2_name === topDriver2) || (item.d1_name === topDriver2 && item.d2_name === topDriver1);
            let key_len = groupedByDateAndTitle[key].length

            if (item.d1_result == "Winner") {
                driver_status.d1.win += 1
                driver_status.d2.lose += 1
            } else if (item.d2_result == "Winner") {
                driver_status.d2.win += 1
                driver_status.d1.lose += 1
            }
            

            if (count == 0) {
                now_data_year = key.slice(0, 4)
                if (driver_status_year[now_data_year] == undefined) {
                    driver_status_year[now_data_year] = {d1:{win:0, lose:0}, d2:{win:0, lose:0}}
                }
            }
            
            if (item.d1_result == "Winner") {
                driver_status_year[now_data_year].d1.win += 1
                driver_status_year["Totale"].d1.win += 1
                driver_status_year[now_data_year].d2.lose += 1
            } else if (item.d2_result == "Winner") {
                driver_status_year[now_data_year].d2.win += 1
                driver_status_year[now_data_year].d1.lose += 1
                driver_status_year["Totale"].d1.lose += 1
            }

            if (isTopDriverMatch || parallel_only == false) {

            if (count == 0) {
                displayHTML += "<div class='date-title-group'>";
                displayHTML += "<div class='date-title'>" + key + "</div>";
            }
            
            var rowClass = isTopDriverMatch ? 'top-driver-match' : '';

            let d1_finishtime_str= (item.d1_finishtime / 1000).toFixed(3);
            let d2_finishtime_str= (item.d2_finishtime / 1000).toFixed(3);

            displayHTML += "<div class='race-entry " + rowClass + "'>";
            displayHTML += "<div class='driver-details'>";
            displayHTML += "<div class='driver-left " + (item.d2_result === "Loser" ? "loser" : "winner") + "'>" + item.d2_name + " - " + d2_finishtime_str + "</div>";
            displayHTML += "<div class='driver-separator'><></div>";
            displayHTML += "<div class='driver-right " + (item.d1_result === "Loser" ? "loser" : "winner") + "'>" + item.d1_name + " - " + d1_finishtime_str + "</div>";
            displayHTML += "</div>";
            displayHTML += "</div>";
            
            if (count == (key_len - 1)) {
                displayHTML += "</div>"; 
            }
            count += 1;
        }
        

        });
        

    });


    for (var key in driver_status_year) {
        document.querySelector(`#overal_driver_table${driver_int} tbody`).insertAdjacentHTML('beforeend', `
        <tr>
            <th scope="row">${key}</th>
            <td>${driver_status_year[key].d1.win}</td>
            <td>${driver_status_year[key].d1.lose}</td>
        </tr>`);
    }


    return displayHTML;
}


function countPlacementsByYear(data) {
    const countsByYear = {};

    data.forEach(item => {
        let record;
        let date;

        // Check if placement is undefined and set record accordingly
        if (item.placement === undefined) {
            record = item.position;
            date = item.date;
        } else {
            record = item.placement;
            date = item.race_date;
        }

        

        // Only consider record values 1, 2, and 3
        if (record >= 1 && record <= 3) {
            const year = new Date(date).getFullYear();

            // Initialize the year array if not already
            if (!countsByYear[year]) {
                countsByYear[year] = [0, 0, 0]; // Array for records 1, 2, 3
            }

            // Increment the count for the relevant record
            countsByYear[year][record - 1]++;
        }
    });

    return countsByYear;
}
function display_snowmobile_models(data, driver) {
    let wins = countPlacementsByYear(data)

    // Start with a table container inside a div
    var displayHTML = "<div class='accordion w-100' id='accordionExample'>"; // Ensure full width

    // Accordion item
    displayHTML += "<div class='accordion-item'>";

    // Accordion header
    displayHTML += "<h2 class='accordion-header' id='headingOne'>";
    displayHTML += `<button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#parallel_accor${driver}' aria-expanded='false' aria-controls='collapseOne'>`;
    

    var string = "<h4 class='accordion-title'> Drag: "; // Add a class for easier CSS targeting

    Object.keys(wins).forEach(key => {
        string += `${key}: `;
        string += `<span style='color: gold; font-weight: bold'>${wins[key][0]}</span>`; // Gold for 1st place
        string += `-<span style='color: silver; font-weight: bold'>${wins[key][1]}</span>`; // Silver for 2nd place
        string += `-<span style='color: #cd7f32; font-weight: bold'>${wins[key][2]}</span> `; // Bronze for 3rd place
        });
    string += "</h4>"
    displayHTML += `${string}`;

    displayHTML += "</button></h2>";
    // Accordion collapse content with table
    displayHTML += `<div id='parallel_accor${driver}' class='accordion-collapse collapse' aria-labelledby='headingOne' data-bs-parent='#accordionExample'>`;
    displayHTML += "<div class='accordion-body'>";

    // Table container inside a div
    displayHTML += "<div class='container-fluid'><table class='table table-striped'>"; // Use container-fluid for full width
        
    // Table header
    displayHTML += "<thead class='thead-dark'><tr>";
    displayHTML += "<th scope='col'>Date</th>";
    displayHTML += "<th scope='col'>Titles</th>";
    displayHTML += "<th scope='col'>Snowmobile</th>";
    displayHTML += "<th scope='col'>Position</th>";
    displayHTML += "</tr></thead>";

    // Table body
    displayHTML += "<tbody>";


    // Iterate over each item in the data array
    data.forEach(function(key) {


        if (key.position == 1) {
            color = "style=background:#FFD700"
        } else if ( key.position == 2 ) {
            color = "style=background:#C0C0C0"
        } else if ( key.position == 3 ) {
            color = "style=background:#CD7F32"
        } else {
            color = ""
        }

        displayHTML += "<tr>";

        // Column for the date
        displayHTML += "<td><b>" + key.date + "</b></td>";

        // Column for the titles
        displayHTML += "<td>" + key.title_1 + " " +  key.title_2 + "</td>";

        // Column for the snowmobile
        displayHTML += "<td>" + key.snowmobile +"</td>";

        // Column for the position
        displayHTML += "<td>" + key.position + "/" + key.total_drivers + "</td>";
        displayHTML += "<td " + color + ">" + " "  + "</td>";

        // Close the row
        displayHTML += "</tr>";
    });

    // Close the table and the container div
    displayHTML += "</tbody></table></div>";

    // Optional: horizontal rule with style
    displayHTML += "<hr class='my-4' style='border-top: 3px solid green;'>";

    return displayHTML;
}

function display_single_position(data, driver) {
    let wins = countPlacementsByYear(data)

    var displayHTML = "<div class='accordion w-100' id='accordionExample'>";

    displayHTML += "<div class='accordion-item'>";

    displayHTML += "<h2 class='accordion-header' id='headingOne'>";
    var string = "<h4 class='accordion-title'>Bakkelop: ";

    try {
    displayHTML += `<button class='accordion-button collapsed' type='button' data-bs-toggle='collapse' data-bs-target='#single_accor${driver}' aria-expanded='false' aria-controls='collapseOne'>`;
        Object.keys(wins).forEach(key => {
        string += `${key}: `;
        string += `<span style='color: gold;font-weight: bold;'>${wins[key][0]}</span>`; 
        string += `-<span style='color: silver;font-weight: bold;'>${wins[key][1]}</span>`; 
        string += `-<span style='color: #cd7f32;font-weight: bold;'>${wins[key][2]}</span> `;
        });
    string += "</h4>"
    displayHTML += `${string}`;

    } catch {
        console.log("Error")
    }

    displayHTML += "</button></h2>";

    displayHTML += `<div id='single_accor${driver}' class='accordion-collapse collapse' aria-labelledby='headingOne' data-bs-parent='#accordionExample'>`;
    displayHTML += "<div class='accordion-body'>";

    displayHTML += "<div class='container-fluid'><table class='table table-striped'>"; // Use container-fluid for full width

    displayHTML += "<thead class='thead-dark'><tr>";
    displayHTML += "<th scope='col'>Date</th>";
    displayHTML += "<th scope='col'>Titles</th>";
    displayHTML += "<th scope='col'>Snowmobile</th>";
    displayHTML += "<th scope='col'>Position</th>";
    displayHTML += "</tr></thead>";

    displayHTML += "<tbody>";



    // Iterate over each item in the data array
    data.forEach(function(key) {

        if (key.placement == 1) {
            color = "style=background:#FFD700"
        } else if ( key.placement == 2 ) {
            color = "style=background:#C0C0C0"
        } else if ( key.placement == 3 ) {
            color = "style=background:#CD7F32"
        } else {
            color = ""
        }

        displayHTML += "<tr>";

        // Column for the date
        displayHTML += "<td><b>" + key.race_date + "</b></td>";

        // Column for the titles
        displayHTML += "<td>" + key.full_race_title + "</td>";

        // Column for the snowmobile
        displayHTML += "<td>" + key.vehicle +"</td>";

        // Column for the position
        displayHTML += "<td>" + key.placement + "/" + key.totale_drivers + "</td>";
        displayHTML += "<td " + color + ">" + " "  + "</td>";

        // Close the row
        displayHTML += "</tr>";
    });

   // Close the table and the container div
   displayHTML += "</tbody></table></div>";

// Close accordion body, item, and container
displayHTML += "</div></div></div></div>";

// Optional: horizontal rule with style
displayHTML += "<hr class='my-4' style='border-top: 3px solid green;'>";

return displayHTML;
}

function display_retry_entries(entries) {
    const tableBody = document.querySelector('#mockDataModal .modal-body table tbody');
    tableBody.innerHTML = ''; // Clear the existing table rows

    // Convert entry driver names to lowercase for case-insensitive comparison
    const entryDriverNamesLower = entries.map(entry => entry.driver_name.toLowerCase());

    // Prepare driver containers and their default T text elements
    const driverContainersInfo = [
        { containerId: 'left-driver', tClass: '.T1' },
        { containerId: 'right-driver', tClass: '.T2' }
    ];

    driverContainersInfo.forEach(info => {
        const container = document.getElementById(info.containerId);
        const tEl = container.querySelector(info.tClass);

        // Reset T text to default state for all drivers first
        if (tEl) {
            tEl.textContent = '0'; // Default state
            tEl.style.color = ''; // Reset color to default
        }

        // Find the driver name element within the container
        const driverNameEl = container.querySelector('.active_drivers');
        if (driverNameEl) {
            const driverNameLower = driverNameEl.textContent.trim().toLowerCase();

            // Mark as "RETRY" if the driver's name is in the entry list
            if (entryDriverNamesLower.includes(driverNameLower)) {
                if (tEl) {
                    tEl.style.color = 'red';
                }
            }
        }
    });

    // Populate the modal table with the current entries
    entries.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${entry.driver_name}</td>
            <td>${entry.title}</td>
            <td>${entry.CID}</td>
        `;
        tableBody.appendChild(row);
    });
}




  </script>
  
</body>
</html>
