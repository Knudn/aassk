{% extends 'home/layout.html' %}
{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cross Results</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    
    <style>
        /* Your existing CSS styles here */
        .accordion {
          font-size: 1rem;
          margin: 0 auto;
          border-radius: 5px;
        }

        .accordion-header,
        .accordion-body {
          background: white;
        }

        .accordion-header {
          padding: 1.5em 1.5em;
          background: #3F51B5;
          color: white;
          cursor: pointer;
          font-size: .7em;
          letter-spacing: .1em;
          transition: all .3s;
          text-transform: uppercase;
        }

        .accordion__item {
            border-bottom: 1px solid #3a4ba4;
        }

        .accordion__item .accordion__item {
          border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .accordion-header:hover {
          background: #2D3D99;
          position: relative;
          z-index: 5;
        }

        .accordion-body {
          background: #fcfcfc;
          color: #353535;
          display: none;
        }

        .accordion-body__contents {
          padding: 1.5em 1.5em;
          font-size: .50em;
        }

        .accordion__item.active:last-child .accordion-header {
          border-radius: none;
        }

        .accordion:first-child > .accordion__item > .accordion-header {
          border-bottom: 1px solid transparent;
        }

        .accordion__item > .accordion-header:after {
          content: "\f3d0";
          font-family: IonIcons;
          font-size: 1.2em;
          float: right;
          position: relative;
          top: -2px;
          transition: .3s all;
          transform: rotate(0deg);
        }

        .accordion__item.active > .accordion-header:after {
          transform: rotate(-180deg);
        }

        .accordion__item.active .accordion-header {
          background: #2D3D99;
        }

        .accordion__item .accordion__item .accordion-header {
          background: #f1f1f1;
          color: #353535;
        }

        @media screen and (max-width: 1000px) {
          body {
            padding: 1em;
          }
          
          .accordion {
            width: 100%;
          }
        }

        .table {
          font-size: large;
        }
    </style>
</head>
<body>
    <div id="accordionContainer" class="accordion js-accordion">
        <!-- Dynamically generated accordion content will go here -->
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
        var accordion = (function () {
            var initialized = false;
            var $accordion, $accordion_header, $accordion_item;
            var settings = { speed: 400, oneOpen: false };

            function init($settings) {
                if (!initialized) {
                    $accordion = $('.js-accordion');
                    $accordion_header = $accordion.find('.js-accordion-header');
                    $accordion_item = $('.js-accordion-item');
                    
                    $accordion_header.on('click', function () {
                        toggle($(this));
                    });

                    initialized = true;
                }

                $.extend(settings, $settings);

                if (settings.oneOpen && $('.js-accordion-item.active').length > 1) {
                    $('.js-accordion-item.active:not(:first)').removeClass('active');
                }

                $('.js-accordion-item.active').find('> .js-accordion-body').show();
            }

            function toggle($this) {
                if (settings.oneOpen && $this[0] != $this.closest('.js-accordion').find('> .js-accordion-item.active > .js-accordion-header')[0]) {
                    $this.closest('.js-accordion')
                        .find('> .js-accordion-item')
                        .removeClass('active')
                        .find('.js-accordion-body')
                        .slideUp();
                }

                $this.closest('.js-accordion-item').toggleClass('active');
                $this.next().stop().slideToggle(settings.speed);
            }

            return { init: init };
        })();

        $(document).ready(function () {
            accordion.init({ speed: 300, oneOpen: true });
        });

        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/get_timedata_cross/')
                .then(response => response.json())
                .then(data => {
                    const groupedByEventAndHeat = groupDataByEventAndHeat(data);
                    createAccordions(groupedByEventAndHeat);
                });
        });

        function groupDataByEventAndHeat(data) {
            const events = {};
            data.forEach(item => {
                const eventName = `${item.title_1} ${item.title_2}`;
                if (!events[eventName]) {
                    events[eventName] = {};
                }
                if (!events[eventName][item.heat]) {
                    events[eventName][item.heat] = [];
                }
                events[eventName][item.heat].push(item);
            });
            return events;
        }

        function format_all_score(data) {
            let new_data = {};
            data.forEach((participant) => {
                const key = participant.first_name + participant.last_name;
                if (!new_data.hasOwnProperty(key)) {
                    new_data[key] = [
                        participant.first_name + " " + participant.last_name,
                        participant.snowmobile,
                        participant.penalty,
                        participant.finishtime,
                        participant.points
                    ];
                } else {
                    let finishtime = new_data[key][3];
                    if (finishtime > participant.finishtime || finishtime == 0) {
                        if (participant.finishtime > 0) {
                            finishtime = participant.finishtime;
                        }
                    }
                    let points = new_data[key][4] + participant.points;
                    new_data[key][4] = points;
                    new_data[key][3] = finishtime;
                }
            });

            const entries = Object.entries(new_data);
            const sortedEntries = entries.sort((a, b) => {
                // First, sort by points in descending order
                if (b[1][4] !== a[1][4]) {
                    return b[1][4] - a[1][4];
                }
                // If points are equal, sort by finishtime in ascending order
                return a[1][3] - b[1][3];
            });

            return sortedEntries;
        }

        function createAccordions(groupedByEventAndHeat) {
            const container = document.getElementById('accordionContainer');
            Object.keys(groupedByEventAndHeat).forEach((eventName) => {
                const eventItem = document.createElement('div');
                eventItem.className = 'accordion__item js-accordion-item';
                eventItem.innerHTML = `
                    <div class="accordion-header js-accordion-header" style="font-size: 15px; padding: 15px;">${eventName}</div>
                    <div class="accordion-body js-accordion-body" style="display: none;">
                        <div class="accordion-body__contents">
                            <!-- Event summary will be added here -->
                        </div>
                    </div>
                `;
                container.appendChild(eventItem);

                const table = document.createElement('table');
                table.className = 'table table-striped';

                const headerRow = table.insertRow();
                ['No.', 'Name', 'Snowmobile','Best Finishtime', 'Points'].forEach(headerText => {
                    const headerCell = document.createElement('th');
                    headerCell.textContent = headerText;
                    headerRow.appendChild(headerCell);
                });

                const participants = Object.values(groupedByEventAndHeat[eventName]).flat();
                const sorted_data = format_all_score(participants);
                sorted_data.forEach((participant, index) => {
                    const [name, snowmobile, , finishtime, points] = participant[1];
                    const row = table.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.insertCell().textContent = name;
                    row.insertCell().textContent = snowmobile;
                    row.insertCell().textContent = finishtime;
                    row.insertCell().textContent = points;
                });

                eventItem.querySelector('.accordion-body__contents').appendChild(table);

                const heats = groupedByEventAndHeat[eventName];
                Object.keys(heats).forEach((heat) => {
                    const heatAccordion = document.createElement('div');
                    heatAccordion.className = 'accordion js-sub-accordion';
                    heatAccordion.innerHTML = `
                        <div class="accordion__item js-accordion-item">
                            <div class="accordion-header js-accordion-header" style="font-size: 18px; padding-top: 5px; padding-bottom: 5px">Heat ${heat}</div>
                            <div class="accordion-body js-accordion-body" style="display: none;">
                                <div class="accordion-body__contents">
                                    <!-- Participants for this heat will be added here -->
                                </div>
                            </div>
                        </div>
                    `;
                    eventItem.querySelector('.accordion-body__contents').appendChild(heatAccordion);

                    const heatTable = document.createElement('table');
                    heatTable.className = 'table table-striped';
                    const thead = heatTable.createTHead();
                    const headerRow = thead.insertRow();
                    ['No.', 'ID', 'Name', 'Snowmobile', 'Penalty', 'Finishtime', 'Points'].forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        headerRow.appendChild(th);
                    });

                    const tbody = heatTable.createTBody();
                    heats[heat].forEach((participant, index) => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = index + 1;
                        row.insertCell().textContent = participant.id;
                        row.insertCell().textContent = `${participant.first_name} ${participant.last_name}`;
                        row.insertCell().textContent = participant.snowmobile;
                        row.insertCell().textContent = participant.penalty;
                        row.insertCell().textContent = participant.finishtime;
                        row.insertCell().textContent = participant.points;
                    });

                    heatAccordion.querySelector('.accordion-body__contents').appendChild(heatTable);
                });
            });
        }

        // Update the accordion toggle functionality to use event delegation
        $(document).on('click', '.js-accordion .js-accordion-header', function() {
            var $this = $(this);
            var $next = $this.next();
            $next.slideToggle(400);
            $this.parent().toggleClass('active');

            if (settings.oneOpen) {
                $this.parent().siblings('.js-accordion-item').each(function() {
                    if ($(this).hasClass('active')) {
                        $(this).removeClass('active');
                        $(this).children('.js-accordion-body').slideUp(400);
                    }
                });
            }
        });
    </script>
</body>
</html>
{% endblock %}