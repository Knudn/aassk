#!/bin/bash

add-apt-repository ppa:rmescandon/yq -y
apt update
apt install postgresql postgresql-contrib jq python3-virtualenv -y

python3 -m venv venv

source venv/bin/activate

homedir=$(pwd)

pip install -r ../slide_app/requirements.txt

yaml_to_json=$(yq r instances.yaml -j)

keys=$(echo "$yaml_to_json" | jq -r 'keys[]')


#Find running instences
netstat -tulpn | grep 5000 | awk '{print $7}' | awk -F "/" '{print $1}' | xargs kill

#Remove old data
rm -rf /tmp/slide1
rm -rf /tmp/slide2
rm -rf /tmp/slide3

#Make tmp data
cp -r ../slide_app /tmp/slide1
cp -r ../slide_app /tmp/slide2
cp -r ../slide_app /tmp/slide3

#Setting up the database
sudo -u postgres ./db.sh slide1
sudo -u postgres ./db.sh slide2
sudo -u postgres ./db.sh slide3

#Adding addresses
ip address add 192.168.10.204/255.255.255.0 dev ens33
ip address add 192.168.10.205/255.255.255.0 dev ens33
ip address add 192.168.10.206/255.255.255.0 dev ens33

#Amount of instences
cd /tmp/slide1; nohup flask run -h 192.168.10.204 -p 5000 > /tmp/slide1/slide1.log 2>&1 &
cd /tmp/slide2; nohup flask run -h 192.168.10.205 -p 5000 > /tmp/slide2/slide2.log 2>&1 &
cd /tmp/slide3; nohup flask run -h 192.168.10.206 -p 5000 > /tmp/slide3/slide3.log 2>&1 &

#Create folder
mkdir -p /tmp/slide1/slideshow/static/images/slideshow_images/
mkdir -p /tmp/slide2/slideshow/static/images/slideshow_images/
mkdir -p /tmp/slide3/slideshow/static/images/slideshow_images/

#Replaces the database config
sed -i -e 's/slideshow:password@database:5432\/slideshow/slide1:slide1@127.0.0.1:5432\/slide1/g' /tmp/slide1/config.py
sed -i -e 's/slideshow:password@database:5432\/slideshow/slide2:slide2@127.0.0.1:5432\/slide2/g' /tmp/slide2/config.py
sed -i -e 's/slideshow:password@database:5432\/slideshow/slide3:slide3@127.0.0.1:5432\/slide3/g' /tmp/slide3/config.py

ps -aux | grep pdf_converte.py | awk '{print $2}'| xargs kill
cd $homedir
python pdf_converte.py -i 192.168.10.204 -d /share/Skjerm1 2>&1 &
python pdf_converte.py -i 192.168.10.205 -d /share/Skjerm2 2>&1 &
python pdf_converte.py -i 192.168.10.206 -d /share/Skjerm3 2>&1 &
